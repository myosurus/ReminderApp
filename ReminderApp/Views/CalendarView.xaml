<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ReminderApp.ViewModels"
             xmlns:converters="clr-namespace:ReminderApp.Converters"
             x:Class="ReminderApp.Views.CalendarView"
             Title="Календарь"
             BackgroundColor="#F7EAFB">

	<ContentPage.BindingContext>
		<viewmodels:CalendarViewModel />
	</ContentPage.BindingContext>

	<ContentPage.Resources>
		<ResourceDictionary>
			<converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
			<converters:MonthTextColorConverter x:Key="MonthTextColorConverter"/>
		</ResourceDictionary>
	</ContentPage.Resources>

	<ScrollView>
		<VerticalStackLayout Padding="20" Spacing="20">

			<!-- Заголовок -->
			<Label Text="Посмотрите, что запланировано на месяц."
                   FontSize="14"
                   TextColor="#666666"/>

			<!-- Навигация по месяцам -->
			<Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
				<Button Grid.Column="0"
                        Text="‹"
                        FontSize="18"
                        FontAttributes="Bold"
                        TextColor="#007AFF"
                        BackgroundColor="Transparent"
                        Command="{Binding PrevMonthCommand}"
                        WidthRequest="40"
                        HeightRequest="40"/>

				<Label Grid.Column="1"
                       Text="{Binding MonthYearText}"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="#333333"
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"/>

				<Button Grid.Column="2"
                        Text="›"
                        FontSize="18"
                        FontAttributes="Bold"
                        TextColor="#007AFF"
                        BackgroundColor="Transparent"
                        Command="{Binding NextMonthCommand}"
                        WidthRequest="40"
                        HeightRequest="40"/>
			</Grid>

            <!-- Сетка календаря -->
			<Border Stroke="#E0E0E0"
                    StrokeThickness="1"
                    BackgroundColor="White"
                    Padding="10">
				<CollectionView ItemsSource="{Binding CalendarDays}"
                                SelectionMode="None"
                                ItemsLayout="VerticalGrid, 7"
                                Margin="0"
                                VerticalOptions="Start">

					<CollectionView.ItemTemplate>
						<DataTemplate>
							<Frame Padding="5"
                                   Margin="2"
                                   CornerRadius="8"
                                   HasShadow="False"
                                   BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}}">
								<VerticalStackLayout HorizontalOptions="Center" 
                                                     VerticalOptions="Center">
									<Label Text="{Binding Date.Day}"
                                           FontSize="14"
                                           TextColor="{Binding IsCurrentMonth, Converter={StaticResource MonthTextColorConverter}}"
                                           HorizontalOptions="Center"/>

									<!--<BoxView HeightRequest="4"
                                             WidthRequest="4"
                                             CornerRadius="2"
                                             BackgroundColor="#5877c7"
                                             IsVisible="{Binding HasReminders}"
                                             HorizontalOptions="Center"/>-->
                                    <HorizontalStackLayout Spacing="2" HorizontalOptions="Center">
                                        <!-- Невыполненные (синие) -->
                                        <BoxView HeightRequest="6"
                                             WidthRequest="6"
                                             CornerRadius="3"
                                             BackgroundColor="#5877c7"
                                             IsVisible="{Binding HasUndone}" />

                                        <!-- Выполненные (серые) -->
                                        <BoxView HeightRequest="6"
                                             WidthRequest="6"
                                             CornerRadius="3"
                                             BackgroundColor="#808080"
                                             IsVisible="{Binding HasDone}" />
                                    </HorizontalStackLayout>

                                </VerticalStackLayout>

								<Frame.GestureRecognizers>
									<TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CalendarViewModel}}, Path=SelectDateCommand}"
                                        CommandParameter="{Binding .}" />
								</Frame.GestureRecognizers>
							</Frame>
						</DataTemplate>
					</CollectionView.ItemTemplate>
				</CollectionView>
			</Border>

			<!-- Задачи на выбранный день -->
			<VerticalStackLayout Spacing="10"
                                 IsVisible="{Binding IsTasksSectionVisible}">
				<Label Text="{Binding SelectedDateText}"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="#333333"/>

				<CollectionView ItemsSource="{Binding DayTasks}"
                                SelectionMode="None">
					<CollectionView.ItemTemplate>
						<DataTemplate>
							<Frame Padding="10"
                                   Margin="4,2"
                                   CornerRadius="8"
                                   HasShadow="False"
                                   BackgroundColor="{Binding Color}">

                                <Frame.GestureRecognizers> <!--добавлено-->
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CalendarViewModel}},
                                                          Path=OpenTaskCommand}"
                                        CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>

                                <Label Text="{Binding Name}"
                                       FontSize="14"
                                       TextColor="White"/>
							</Frame>
						</DataTemplate>
					</CollectionView.ItemTemplate>
				</CollectionView>


                <Button Text="Добавить задачу на этот день"
                        BackgroundColor="#007AFF"
                        TextColor="White"
                        CornerRadius="5"
                        HeightRequest="40"
                        Command="{Binding AddTaskCommand}" />
			</VerticalStackLayout>

			<!-- Разделитель -->
			<BoxView HeightRequest="1" Color="#EEEEEE"/>

			<!-- Обозначения -->
			<VerticalStackLayout Spacing="10">
				<Label Text="Обозначения:"
                       FontSize="14"
                       FontAttributes="Bold"
                       TextColor="#333333"/>

				<Grid ColumnDefinitions="Auto,*" RowDefinitions="*,*" RowSpacing="8">
					<Frame Grid.Row="0" Grid.Column="0"
                           BackgroundColor="#5877c7"
                           HeightRequest="16"
                           WidthRequest="16"
                           Padding="0"
                           HasShadow="False"
                           CornerRadius="8"/>
					<Label Grid.Row="0" Grid.Column="1"
                           Text="Невыполненные задачи"
                           FontSize="12"
                           TextColor="#333333"
                           VerticalTextAlignment="Center"
                           Margin="10,0,0,0"/>

					<Frame Grid.Row="1" Grid.Column="0"
                           BackgroundColor="#BDBDBD"
                           HeightRequest="16"
                           WidthRequest="16"
                           Padding="0"
                           HasShadow="False"
                           CornerRadius="8"/>
					<Label Grid.Row="1" Grid.Column="1"
                           Text="Выполненные задачи"
                           FontSize="12"
                           TextColor="#333333"
                           VerticalTextAlignment="Center"
                           Margin="10,0,0,0"/>
				</Grid>
			</VerticalStackLayout>
		</VerticalStackLayout>
	</ScrollView>
</ContentPage>
